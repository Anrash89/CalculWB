<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Калькулятор маржи WB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Tom‑Select (быстрый поиск по 7 000 позициям) -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />
  
  <style>
    :root{--wb-purple:#a500ff;--wb-purple-dark:#8a00d9;--grey-900:#333;--grey-600:#666;--grey-100:#f7f7f7;--white:#fff;--success:#28a745;--danger:#dc3545}
    *{box-sizing:border-box;font-family:"Segoe UI",Arial,sans-serif}
    body{margin:0;background:var(--grey-100);display:flex;justify-content:center;padding:40px 16px}
    .card{width:100%;max-width:650px;background:var(--white);border-radius:16px;padding:32px 28px;box-shadow:0 10px 30px rgba(0,0,0,.08);animation:fade .8s ease-out}
    @keyframes fade{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
    h1{margin:0 0 28px;text-align:center;font-size:1.9rem;color:var(--wb-purple)}
    .row{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:20px}
    .row.three-col{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media(max-width:560px){.row.three-col{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:420px){.row.three-col{grid-template-columns:1fr}}
    label{flex:1 1 200px;display:flex;flex-direction:column;font-size:.95rem;color:var(--grey-600)}
    select,input[type=number]{margin-top:6px;padding:10px 12px;font-size:1rem;border:1px solid #ddd;border-radius:10px;min-width:0}
    select:focus,input:focus{border-color:var(--wb-purple);outline:none;box-shadow:0 0 0 3px rgba(165,0,255,.2)}
    button{display:block;width:100%;max-width:260px;margin:0 auto;padding:14px 20px;font-size:1.1rem;font-weight:600;color:var(--white);background:var(--wb-purple);border:0;border-radius:12px;cursor:pointer;transition:.25s all}
    button:hover{background:var(--wb-purple-dark);transform:translateY(-3px);box-shadow:0 8px 15px rgba(165,0,255,.25)}
    button:active{transform:none;box-shadow:0 4px 10px rgba(165,0,255,.15)}
    .output{margin-top:36px;border-top:1px solid #eee;padding-top:24px;opacity:0;animation:show .6s forwards}
    @keyframes show{to{opacity:1}}
    .output-item{display:flex;justify-content:space-between;margin-bottom:10px;font-size:1rem}
    .output-item span:first-child{font-weight:600}
    .output-item span:last-child{font-weight:600;color:var(--wb-purple)}
    .positive{color:var(--success)!important}.negative{color:var(--danger)!important}
    .info{margin-top:24px;font-size:.85rem;color:var(--grey-600);background:#fafafa;border:1px solid #eee;border-radius:10px;padding:14px 16px;line-height:1.5}
  </style>
</head>
<body>
  <div class="card">
    <h1>Калькулятор маржи WB</h1>

    <!-- Категория и режим -->
    <div class="row">
      <label>
        Категория
        <select id="category" placeholder="Начните вводить…" disabled></select>
      </label>
      <label>
        Режим работы
        <select id="mode">
          <option value="commission_fbw">FBW (Склад WB)</option>
          <option value="commission_fbs">FBS (Маркетплейс)</option>
          <option value="commission_dbs">DBS / DBW</option>
          <option value="commission_cc">C&C (Самовывоз)</option>
          <option value="commission_edbs">EDBS (Экспресс)</option>
          <option value="commission_reserve">Бронирование</option>
        </select>
      </label>
    </div>

    <!-- Цены -->
    <div class="row">
      <label> Себестоимость, ₽ <input type="number" id="costPrice" value="1000" min="0" step="0.01"> </label>
      <label> Цена продажи, ₽ <input type="number" id="sellingPrice" value="2500" min="0" step="0.01"> </label>
    </div>

    <!-- Габариты -->
    <div class="row three-col">
      <label> Длина, см <input type="number" id="length" value="20" min="0" step="0.1"> </label>
      <label> Ширина, см <input type="number" id="width" value="15" min="0" step="0.1"> </label>
      <label> Высота, см <input type="number" id="height" value="10" min="0" step="0.1"> </label>
    </div>

    <!-- Прочее -->
    <div class="row">
      <label> Хранение, ₽ <input type="number" id="storage" value="10" min="0" step="0.01"></label>
      <label> Прочие расходы, ₽ <input type="number" id="otherCosts" value="0" min="0" step="0.01"></label>
    </div>

    <button id="calculate">Рассчитать</button>

    <div id="results" style="display:none" class="output">
      <div class="output-item"><span>Комиссия (вкл. НДС)</span><span id="commissionAmount">0 ₽</span></div>
      <div class="output-item"><span>Логистика (вкл. НДС)</span><span id="logisticsAmount">0 ₽</span></div>
      <div class="output-item"><span>Возмещение НДС</span><span id="vatRefund">0 ₽</span></div>
      <div class="output-item"><span>Общие расходы</span><span id="totalCosts">0 ₽</span></div>
      <div class="output-item"><span>Валовая прибыль</span><span id="grossProfit">0 ₽</span></div>
      <div class="output-item"><span>Налог на прибыль 20%</span><span id="profitTax">0 ₽</span></div>
      <div class="output-item"><span>Чистая прибыль</span><span id="netProfit">0 ₽</span></div>
      <div class="output-item"><span>Маржа</span><span id="margin">0%</span></div>
    </div>

    <p class="info">
      В списке отображаются все 7 000 строк, включая дубли. Вводите пару букв — Tom‑Select мгновенно отфильтрует.<br>
      Логистика: 75 ₽ за 1‑й литр + 15 ₽ за каждый следующий (объём округляется вверх).
    </p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <script>
    const VAT=0.20, PROFIT_TAX=0.20;
    let categories=[];
    const money=n=>n.toLocaleString('ru-RU',{style:'currency',currency:'RUB',minimumFractionDigits:2});

    /* === Загрузка categories.json: value = индекс, чтобы не терять дубли === */
    fetch('categories.json')
      .then(r=>r.json())
      .then(data=>{
        categories=data;
        const sel=document.getElementById('category');
        sel.innerHTML=data.map((c,i)=>`<option value="${i}">${c.category}</option>`).join('');
        sel.disabled=false;
        new TomSelect(sel,{maxOptions:9999,placeholder:'Начните вводить…',sortField:{field:'text',direction:'asc'}});
      })
      .catch(err=>console.error('categories.json load error',err));

    document.getElementById('calculate').addEventListener('click',calc);

    function calc(){
      const idx=parseInt(document.getElementById('category').value,10);
      const mode=document.getElementById('mode').value;
      const cat=categories[idx]||{};

      const L=+qs('length').value||0,W=+qs('width').value||0,H=+qs('height').value||0;
      const cost=+qs('costPrice').value||0,sell=+qs('sellingPrice').value||0;
      const storage=+qs('storage').value||0,other=+qs('otherCosts').value||0;

      const commPct=+cat[mode]||0;
      const commWithVat=(sell*commPct)/100,commVatRefund=commWithVat*VAT/(1+VAT);
      const litres=Math.ceil((L*W*H)/1000);
      const logWithVat=litres?75+Math.max(0,litres-1)*15:0;
      const logVatRefund=logWithVat*VAT/(1+VAT);
      const costs=cost+(commWithVat-commVatRefund)+(logWithVat-logVatRefund)+storage+other;
      const gross=sell-costs; const pTax=gross>0?gross*PROFIT_TAX:0; const net=gross-pTax; const margin=sell?net/sell*100:0;

      out('commissionAmount',money(commWithVat));
      out('logisticsAmount',money(logWithVat));
      out('vatRefund',money(commVatRefund+logVatRefund));
      out('totalCosts',money(costs));
      out('grossProfit',money(gross));
      out('profitTax',money(pTax));
      out('netProfit',money(net));
      out('margin',margin.toFixed(2)+'%');

      ['netProfit','margin'].forEach(id=>{qs(id).classList.toggle('positive',net>=0);qs(id).classList.toggle('negative',net<0)});
      const res=qs('results');res.style.display='block';res.classList.remove('output');void res.offsetWidth;res.classList.add('output');
    }

    const qs=id=>document.getElementById(id),out=(id,val)=>qs(id).textContent=val;
  </script>
</body>
</html>
