<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Калькулятор маржи WB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tom‑Select (поиск по списку категорий) -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />

  <style>
    :root {
      --wb-purple: #a500ff;
      --wb-purple-dark: #8a00d9;
      --grey-900: #333;
      --grey-600: #666;
      --grey-100: #f7f7f7;
      --white: #ffffff;
      --success: #28a745;
      --danger: #dc3545;
    }
    * { box-sizing: border-box; font-family: "Segoe UI", Arial, sans-serif; }
    body {
      margin: 0; background: var(--grey-100); display: flex; justify-content: center; padding: 40px 16px;
    }
    .card {
      width: 100%; max-width: 650px; background: var(--white); border-radius: 16px; padding: 32px 28px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08); animation: fade 0.8s ease-out;
    }
    @keyframes fade { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:none;} }
    h1 { margin: 0 0 28px; text-align: center; font-size: 1.9rem; color: var(--wb-purple); }

    .row { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 20px; }
    .row.three-col label { flex: 1 1 calc(33.333% - 16px); }
    label { flex:1 1 200px; display:flex; flex-direction:column; font-size:0.95rem; color:var(--grey-600); }
    select, input[type=number] {
      margin-top: 6px; padding: 10px 12px; font-size:1rem; border:1px solid #ddd; border-radius:10px;
    }
    select:focus, input:focus { border-color: var(--wb-purple); outline:none; box-shadow:0 0 0 3px rgba(165,0,255,.2); }

    button { display:block; width:100%; max-width:260px; margin:0 auto; padding:14px 20px; font-size:1.1rem; font-weight:600;
      color:var(--white); background:var(--wb-purple); border:0; border-radius:12px; cursor:pointer; transition:.25s all; }
    button:hover { background:var(--wb-purple-dark); transform:translateY(-3px); box-shadow:0 8px 15px rgba(165,0,255,.25); }
    button:active { transform:none; box-shadow:0 4px 10px rgba(165,0,255,.15); }

    .output { margin-top:36px; border-top:1px solid #eee; padding-top:24px; opacity:0; animation:show .6s forwards; }
    @keyframes show { to{opacity:1;} }
    .output-item { display:flex; justify-content:space-between; margin-bottom:10px; font-size:1rem; }
    .output-item span:first-child{ font-weight:600; }
    .output-item span:last-child{ font-weight:600; color:var(--wb-purple); }
    .positive{ color:var(--success) !important; }
    .negative{ color:var(--danger) !important; }

    .info { margin-top:24px; font-size:.85rem; color:var(--grey-600); background:#fafafa; border:1px solid #eee; border-radius:10px; padding:14px 16px; line-height:1.5; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Калькулятор маржи WB</h1>

    <!-- Категория и режим -->
    <div class="row">
      <label>
        Категория
        <select id="category" placeholder="Начните вводить…" disabled></select>
      </label>
      <label>
        Режим работы
        <select id="mode">
          <option value="commission_fbw">FBW (Склад WB)</option>
          <option value="commission_fbs">FBS (Маркетплейс)</option>
          <option value="commission_dbs">DBS / DBW</option>
          <option value="commission_cc">C&C (Самовывоз)</option>
          <option value="commission_edbs">EDBS (Экспресс)</option>
          <option value="commission_reserve">Бронирование</option>
        </select>
      </label>
    </div>

    <!-- Цены -->
    <div class="row">
      <label> Себестоимость, ₽ <input type="number" id="costPrice" value="1000" min="0" step="0.01"> </label>
      <label> Цена продажи, ₽ <input type="number" id="sellingPrice" value="2500" min="0" step="0.01"> </label>
    </div>

    <!-- Габариты -->
    <div class="row three-col">
      <label> Длина, см <input type="number" id="length" value="20" min="0" step="0.1"> </label>
      <label> Ширина, см <input type="number" id="width" value="15" min="0" step="0.1"> </label>
      <label> Высота, см <input type="number" id="height" value="10" min="0" step="0.1"> </label>
    </div>

    <!-- Прочее -->
    <div class="row">
      <label> Хранение, ₽ <input type="number" id="storage" value="10" min="0" step="0.01"> </label>
      <label> Прочие расходы, ₽ <input type="number" id="otherCosts" value="0" min="0" step="0.01"> </label>
    </div>

    <button id="calculate">Рассчитать</button>

    <div id="results" style="display:none" class="output">
      <div class="output-item"><span>Комиссия (вкл. НДС)</span><span id="commissionAmount">0 ₽</span></div>
      <div class="output-item"><span>Логистика (вкл. НДС)</span><span id="logisticsAmount">0 ₽</span></div>
      <div class="output-item"><span>Возмещение НДС</span><span id="vatRefund">0 ₽</span></div>
      <div class="output-item"><span>Общие расходы</span><span id="totalCosts">0 ₽</span></div>
      <div class="output-item"><span>Валовая прибыль</span><span id="grossProfit">0 ₽</span></div>
      <div class="output-item"><span>Налог на прибыль 20%</span><span id="profitTax">0 ₽</span></div>
      <div class="output-item"><span>Чистая прибыль</span><span id="netProfit">0 ₽</span></div>
      <div class="output-item"><span>Маржа</span><span id="margin">0%</span></div>
    </div>

    <p class="info">
      Категорию можно найти поиском — начните печатать, список фильтруется.<br>Логистика: 75 ₽ за первый литр + 15 ₽ за каждый следующий литр. Объём округляется вверх до целого литра (как на WB).
    </p>
  </div>

  <!-- Tom‑Select -->
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

  <script>
    /* === Константы === */
    const VAT = 0.20;             // НДС 20 %
    const PROFIT_TAX = 0.20;      // Налог на прибыль 20 %

    let categories = [];

    // Формат денег
    const money = n => n.toLocaleString('ru-RU', {style:'currency',currency:'RUB',minimumFractionDigits:2});

    /* === Загрузка категорий === */
    fetch('categories.json')
      .then(r => r.json())
      .then(data => {
        categories = data;
        const select = document.getElementById('category');
        select.innerHTML = data.map(c => `<option value="${c.category}">${c.category}</option>`).join('');
        select.disabled = false;
        // подключаем Tom‑Select
        new TomSelect(select, {
          maxOptions: 5000,
          sortField: {field:'text',direction:'asc'},
          placeholder: 'Начните вводить…'
        });
      })
      .catch(err => console.error('Failed to load categories', err));

    /* === Расчёт === */
    document.getElementById('calculate').addEventListener('click', calc);

    function calc(){
      const catName = document.getElementById('category').value;
      const mode    = document.getElementById('mode').value;

      const costPrice    = +document.getElementById('costPrice').value||0;
      const sellingPrice = +document.getElementById('sellingPrice').value||0;

      const L = +document.getElementById('length').value||0;
      const W = +document.getElementById('width').value||0;
      const H = +document.getElementById('height').value||0;

      const storage  = +document.getElementById('storage').value||0;
      const otherExp = +document.getElementById('otherCosts').value||0;

      // --- комиссия ---
      const cat = categories.find(c=>c.category===catName)||{};
      const commissionPct = +cat[mode] || 0;
      const commissionWithVat = (sellingPrice * commissionPct)/100;
      const commissionVatRefund = commissionWithVat*VAT/(1+VAT);

      // --- логистика ---
      const litresRaw = (L*W*H)/1000;          // литры с десятыми
      const litres = Math.ceil(litresRaw);      // округ вверх до целого
      const logisticsWithVat = litres>0 ? 75 + Math.max(0,litres-1)*15 : 0;
      const logisticsVatRefund = logisticsWithVat*VAT/(1+VAT);

      // --- расходы ---
      const totalCosts = costPrice + (commissionWithVat-commissionVatRefund) + (logisticsWithVat-logisticsVatRefund) + storage + otherExp;

      // --- прибыль ---
      const grossProfit = sellingPrice - totalCosts;
      const profitTax   = grossProfit>0 ? grossProfit*PROFIT_TAX : 0;
      const netProfit   = grossProfit - profitTax;
      const marginPct   = sellingPrice ? (netProfit/sellingPrice)*100 : 0;

      // --- вывод ---
      qs('commissionAmount').textContent = money(commissionWithVat);
      qs('logisticsAmount').textContent  = money(logisticsWithVat);
      qs('vatRefund').textContent        = money(commissionVatRefund+logisticsVatRefund);
      qs('totalCosts').textContent       = money(totalCosts);
      qs('grossProfit').textContent      = money(grossProfit);
      qs('profitTax').textContent        = money(profitTax);
      qs('netProfit').textContent        = money(netProfit);
      qs('margin').textContent           = marginPct.toFixed(2)+'%';

      // цвет
      ['netProfit','margin'].forEach(id=>{
        const el=qs(id); el.classList.toggle('positive', netProfit>=0);
        el.classList.toggle('negative', netProfit<0);
      });

      // показать
      const res=document.getElementById('results');
      res.style.display='block'; res.classList.remove('output'); void res.offsetWidth; res.classList.add('output');
    }

    const qs = id => document.getElementById(id);
  </script>
</body>
</html>
