<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Калькулятор маржи Wildberries</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --wb-purple: #a500ff;
      --wb-purple-dark: #8a00d9;
      --grey-900: #333;
      --grey-600: #666;
      --grey-100: #f7f7f7;
      --white: #ffffff;
      --success: #28a745;
      --danger: #dc3545;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--grey-100);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 16px;
      color: var(--grey-900);
    }

    .card {
      width: 100%;
      max-width: 620px;
      background: var(--white);
      border-radius: 16px;
      padding: 32px 28px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0);   }
    }

    h1 {
      margin: 0 0 28px;
      text-align: center;
      font-size: 1.8rem;
      color: var(--wb-purple);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 20px;
    }

    label {
      flex: 1 1 180px;
      display: flex;
      flex-direction: column;
      font-size: 0.95rem;
      color: var(--grey-600);
    }

    input[type="number"], select {
      margin-top: 6px;
      padding: 10px 12px;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      transition: border-color 0.25s, box-shadow 0.25s;
    }

    input:focus, select:focus {
      border-color: var(--wb-purple);
      outline: none;
      box-shadow: 0 0 0 3px rgba(165, 0, 255, 0.2);
    }

    button {
      display: inline-block;
      width: 100%;
      max-width: 260px;
      margin: 0 auto;
      padding: 14px 20px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--white);
      background: var(--wb-purple);
      border: 0;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.25s, transform 0.25s, box-shadow 0.25s;
    }

    button:hover {
      background: var(--wb-purple-dark);
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(165, 0, 255, 0.25);
    }

    button:active {
      transform: none;
      box-shadow: 0 4px 10px rgba(165, 0, 255, 0.15);
    }

    .output {
      margin-top: 36px;
      border-top: 1px solid #eee;
      padding-top: 24px;
      opacity: 0;
      animation: show 0.6s forwards ease-out;
    }

    @keyframes show { to { opacity: 1; } }

    .output-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .output-item span:first-child {
      font-weight: 600;
    }

    .output-item span:last-child {
      font-weight: 600;
      color: var(--wb-purple);
    }

    .positive { color: var(--success) !important; }
    .negative { color: var(--danger)  !important; }

    .info {
      margin-top: 24px;
      font-size: 0.85rem;
      color: var(--grey-600);
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 14px 16px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Калькулятор маржи WB</h1>

    <!-- Категория и режим -->
    <div class="row">
      <label>
        Категория
        <select id="category" disabled>
          <option>Загрузка…</option>
        </select>
      </label>
      <label>
        Режим работы
        <select id="mode">
          <option value="commission_fbw">FBW (Склад WB)</option>
          <option value="commission_fbs">FBS (Маркетплейс)</option>
          <option value="commission_dbs">DBS / DBW (Витрина)</option>
          <option value="commission_cc">C&C (Самовывоз)</option>
          <option value="commission_edbs">EDBS (Экспресс)</option>
          <option value="commission_reserve">Бронирование</option>
        </select>
      </label>
    </div>

    <!-- Базовые цены -->
    <div class="row">
      <label>
        Себестоимость, ₽
        <input type="number" id="costPrice" value="1000" min="0" step="0.01" />
      </label>
      <label>
        Цена продажи, ₽
        <input type="number" id="sellingPrice" value="2500" min="0" step="0.01" />
      </label>
    </div>

    <!-- Габариты -->
    <div class="row">
      <label>
        Длина, см
        <input type="number" id="length" value="20" min="0" step="0.1" />
      </label>
      <label>
        Ширина, см
        <input type="number" id="width" value="15" min="0" step="0.1" />
      </label>
      <label>
        Высота, см
        <input type="number" id="height" value="10" min="0" step="0.1" />
      </label>
    </div>

    <!-- Прочие расходы -->
    <div class="row">
      <label>
        Хранение, ₽
        <input type="number" id="storage" value="10" min="0" step="0.01" />
      </label>
      <label>
        Прочие расходы, ₽
        <input type="number" id="otherCosts" value="0" min="0" step="0.01" />
      </label>
    </div>

    <button id="calculate">Рассчитать</button>

    <!-- Вывод -->
    <div id="results" class="output" style="display:none">
      <div class="output-item"><span>Комиссия (вкл. НДС)</span><span id="commissionAmount">0 ₽</span></div>
      <div class="output-item"><span>Логистика (вкл. НДС)</span><span id="logisticsAmount">0 ₽</span></div>
      <div class="output-item"><span>Возмещение НДС</span><span id="vatRefund">0 ₽</span></div>
      <div class="output-item"><span>Общие расходы</span><span id="totalCosts">0 ₽</span></div>
      <div class="output-item"><span>Валовая прибыль</span><span id="grossProfit">0 ₽</span></div>
      <div class="output-item"><span>Налог на прибыль 20%</span><span id="profitTax">0 ₽</span></div>
      <div class="output-item"><span>Чистая прибыль</span><span id="netProfit" class="positive">0 ₽</span></div>
      <div class="output-item"><span>Маржа</span><span id="margin" class="positive">0%</span></div>
    </div>

    <p class="info">
      Комиссия подставляется по выбранной категории и режиму работы.<br>
      Стоимость логистики: 75 ₽ за первый литр объёма + 15 ₽ за каждый следующий литр (все суммы с НДС 20 %). Возмещение НДС учитывается автоматически.
    </p>
  </div>

  <script>
    /* ============================================================
       Настройки
    ============================================================ */
    const VAT_RATE = 0.20;        // 20 % НДС
    const PROFIT_TAX_RATE = 0.20; // 20 % налог на прибыль

    let categories = [];          // сюда загрузим JSON

    // Форматирование денег
    function money(n) {
      return n.toLocaleString('ru-RU', {
        style: 'currency', currency: 'RUB', minimumFractionDigits: 2
      });
    }

    /* ============================================================
       Подгружаем категории
    ============================================================ */
    fetch('categories.json')
      .then(r => r.json())
      .then(data => {
        categories = data;
        const select = document.getElementById('category');
        select.innerHTML = '';
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.category;
          opt.textContent = cat.category;
          select.appendChild(opt);
        });
        select.disabled = false;
      })
      .catch(err => {
        console.error('Не удалось загрузить categories.json', err);
        alert('Ошибка загрузки списка категорий — проверьте консоль.');
      });

    /* ============================================================
       Основная логика расчёта
    ============================================================ */
    document.getElementById('calculate').addEventListener('click', calculate);

    function calculate() {
      // Данные формы
      const categoryName = document.getElementById('category').value;
      const modeField = document.getElementById('mode').value;

      const costPrice   = +document.getElementById('costPrice').value || 0;
      const sellingPrice= +document.getElementById('sellingPrice').value || 0;

      const length = +document.getElementById('length').value || 0;
      const width  = +document.getElementById('width').value  || 0;
      const height = +document.getElementById('height').value || 0;

      const storage = +document.getElementById('storage').value || 0;
      const other   = +document.getElementById('otherCosts').value || 0;

      // 1. Найти объект категории
      const cat = categories.find(c => c.category === categoryName);
      const commissionPercent = cat ? (+cat[modeField] || 0) : 0;

      // 2. Комиссия (с НДС)
      const commissionWithVat = (sellingPrice * commissionPercent) / 100;
      const commissionVatRefund = commissionWithVat * VAT_RATE / (1 + VAT_RATE);

      // 3. Логистика по объёму (см³ → литры)
      const litres = (length * width * height) / 1000; // 1000 см³ = 1 л
      const logisticsWithVat = litres > 0 ? 75 + Math.max(0, litres - 1) * 15 : 0;
      const logisticsVatRefund = logisticsWithVat * VAT_RATE / (1 + VAT_RATE);

      // 4. Итоговые расходы с учётом возмещения НДС
      const totalCosts = costPrice + (commissionWithVat - commissionVatRefund) +
                         (logisticsWithVat - logisticsVatRefund) + storage + other;

      // 5. Прибыль & налоги
      const grossProfit = sellingPrice - totalCosts;
      const profitTax   = grossProfit > 0 ? grossProfit * PROFIT_TAX_RATE : 0;
      const netProfit   = grossProfit - profitTax;
      const margin      = sellingPrice ? (netProfit / sellingPrice) * 100 : 0;

      /* --------------------------------------------------------
         Вывод
      -------------------------------------------------------- */
      document.getElementById('commissionAmount').textContent = money(commissionWithVat);
      document.getElementById('logisticsAmount').textContent  = money(logisticsWithVat);
      document.getElementById('vatRefund').textContent        = money(commissionVatRefund + logisticsVatRefund);
      document.getElementById('totalCosts').textContent       = money(totalCosts);
      document.getElementById('grossProfit').textContent      = money(grossProfit);
      document.getElementById('profitTax').textContent        = money(profitTax);
      document.getElementById('netProfit').textContent        = money(netProfit);
      document.getElementById('margin').textContent           = margin.toFixed(2) + '%';

      // Цвет для прибыли / маржи
      const profitEl = document.getElementById('netProfit');
      const marginEl = document.getElementById('margin');
      [profitEl, marginEl].forEach(el => {
        el.classList.remove('positive', 'negative');
        el.classList.add(netProfit >= 0 ? 'positive' : 'negative');
      });

      // Показать блок результатов
      const res = document.getElementById('results');
      res.style.display = 'block';
      res.classList.remove('output'); // перезапуск анимации
      void res.offsetWidth;
      res.classList.add('output');
    }
  </script>
</body>
</html>